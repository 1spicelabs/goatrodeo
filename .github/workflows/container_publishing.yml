name: Publish Container Images

#on: workflow_dispatch
  #release:
  #  types: [published] # todo - change this to trigger on other workflows
  #push:
  #  branches:
  #    - main
  #workflow_run:
  #  workflows: [Scala Build & Test]
  #  types:
  #    - completed
on:
  push:
    branches: [ "main" ]
    # Publish semver tags as releases.
    tags: [ 'v*.*.*' ]
  pull_request:
    branches: [ "main" ]
jobs:
    push_to_registry:
      name: Push Docker image to Docker Hub
      runs-on: ubuntu-latest
      permissions:
        packages: write
        contents: read
        attestations: write
        id-token: write
      steps:
        - name: Check out the repository
          uses: actions/checkout@v4
        - name: Set up JDK 21
          uses: actions/setup-java@v3
          with:
            java-version: '21'
            distribution: 'adopt-hotspot'
            cache: 'sbt'
        - name: Log in to Docker Hub
          uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_TOKEN }}
        - name: Extract metadata (tags, labels) for Docker
          id: meta
          uses: docker/metadata-action@9ec57ed1fcdbf14dcef7dfbe97b2010124a938b7
          with:
            images: spicelabs/goatrodeo
        - name: Build and publish local image
          run: |
            sbt Docker/publishLocal
